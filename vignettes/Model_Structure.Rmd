---
title: "Model Structure Details"
author: "Malcolm Haddon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Model_Structure}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

options(knitr.kable.NA = "",
        knitr.table.format = "pandoc")

options("show.signif.stars"=FALSE,
        "stringsAsFactors"=FALSE,
        "max.print"=50000,
        "width"=240)

library(diagrams)
library(aMSE)
library(knitr)
library(captioner)

tab_nums <- captioner(prefix = "Table")
fig_nums <- captioner(prefix = "Figure")

```


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { 
      equationNumbers: { 
            autoNumber: "all",
            formatNumber: function (n) {return '3.'+n}
      } 
  }
});
</script>



# Introduction

### Management Strategy Evaluation

Comparing the relative effectiveness of alternative harvest strategies for particular fisheries generally requires the use of Management Strategy Evaluation (Haddon, 2007; Punt _et al_. 2016). As stated by Punt _et al_. (2016, p303). 

"Management strategy evaluation (MSE) involves using simulation to compare the relative effectiveness for achieving management objectives of different combinations of data collection schemes, methods of analysis and subsequent processes leading to management actions. MSE can be used to identify a ‘best’ management strategy among a set of candidate strategies, or to determine how well an existing strategy performs. The ability of MSE to facilitate fisheries management achieving its aims depends on how well uncertainty is represented, and how effectively the results of simulations are summarized and presented to the decision-makers. Key challenges for effective use of MSE therefore include characterizing objectives and uncertainty, assigning plausibility ranks to the trials considered, and working with decision makers to interpret and implement the results of the MSE." 

The simulations referred to involve simulating the biological and fishery/fleet dynamics of the fishery being considered. This simulation model, usually termed the _Operating Model_ is either fitted to a real fishery or conditioned to reflect the observed properties of a real fishery. EXPAND Once conditioned, the operating model is taken to represent reality and is used to simulate the dynamics of a fishery as it would operate under the different harvest strategies (HS).  

The essential aspect of the simulation that makes an MSE differ from a standard forward projection of a stock assessment (a classical risk assessment; Francis, 1992) is the built in feedback of the regular management advice. The complete dynamics of the stock and fishery are simulated each year, the HS (data sampling, assessment/analysis, and harvest control rule) is applied however often the HS dictates, and the outcome of the simulated HS is fed back into the operating model, which could be expected to alter the path of the expected dynamics. In this way different HS can be expected to have different simulation outcomes over a set number of years.

### Simpler is Not Necessarily Better

MSE is often represented in an overly simplistic fashion leading to un-realistic expectations. It is important to remember that, as with any model, if an operating model does not include a particular feature in its dynamics (e.g. does not include depensation in its recruitment dynamics, or non-linearity in the relationship between stock biomass and CPUE) then those features can never be expressed in the simulations. The structure of an operating model needs to be well documented and its limitations understood so that the limitations of the MSE testing of each HS are known. This is especially important to understand because harvest strategies that have been MSE tested are generally held in relatively high regard. However, the MSE testing will always be constrained to the dynamics described by the operating model, so care in its design is required and that design needs to be defensible.

### Harvest Strategies

A harvest strategy (Smith, 1997), or HS, has a minimum of three components:

1. Specified and representative data collected from the fishery being evaluated

2. An Assessment or analysis of the fishery, based on the data collected, that estimates its status relative to pre-defined target and limit reference points

3. A formal harvest control rule (decision rule) that defines previously agreed management advice (future catch or effort levels, etc) in response to a stock's status relative to its reference points.

Each of the three components can be varied in multiple ways and each such combination would constitute a different harvest strategy (HS). For any fishery, therefore, there will be multiple potential options available for the management. Generally, fishery management involves balancing trade-offs between conflicting objectives. For example, with a valuable species such as abalone (e.g. blacklip abalone, _Haliotis rubra_) the two objectives of maintaining a sustainable stock and maximizing the profitable catch are potentially in conflict. Such potential conflicts are why management strategy evaluation was developed to enable the comparison of alternative harvest strategies. It is used to select an optimum HS, or at least reject sub-optimal ones.

### Management Strategy Evaluation of Abalone Fisheries

There have been attempts to conduct management strategy evaluation (MSE) of alternative harvest strategies for abalone fisheries (Haddon _et al_., 2011; Haddon and Mundy, 2016; Haddon and Helidoniotis, 2013), and a recent R package __aMSE__ has been developed and has evolved following on from those attempts. 

The R code in the __aMSE__ package is the start of a translation of the Abalone MSE code developed and used in Haddon _et al_ (2013), which was developed further in Haddon and Mundy (2016). The essential equations describing the operating model dynamics were formally published in Haddon and Helidoniotis (2013). Those dynamics have since been found to be overly complex in that they used separate vectors of numbers-at-length to describe the cryptic and emergent components of each abalone population. Other unpublished work demonstrated that this separation has no real advantages but does have computational disadvantages. The new __aMSE__ package reflects this by translating the previous code into using a single vector of numbers-at-length to contain the dynamics. In addition, other methods are being incrementally implemented with the intent of speeding the computations, which previously could take many hours to appropriately explore even a single HS.

The underlying objective in the current R package is to enable the simulations and MSE testing of different HS to proceed by users familiar with R, but without months of introductory training with the software and concepts involved. This vignette is a first attempt to provide the background required for others to successfully run the software. While writing this vignette sections will be borrowed freely from both Haddon _et al_ (2013) and Haddon and Mundy (2016) wherever it is appropriate. These two original projects in which the abalone MSE code was first developed did not provide sufficient time or resources to generate a more user-friendly code-base for the software. The lack of such more user-friendly software greatly reduces the capacity to apply these methods to more stocks or new HS currently being developed. By making the new R package freely available the intent and hope is that more people will find the methods workable. By being made open source software this also allows for future developments of the package by others should they wish. One primary objective is to allow users to write their own functions describing any new harvest strategy they might develop. How difficult arranging such an open interface will be has yet to be discovered.  

### Difficulties Inherent with MSE Testing Abalone HS

The phrase 'abalone stock' sounds meaningful and most would consider this to refer to the standard notion of populations of a species having sufficient genetic homogeneity to represent a reproductively connected whole. However, as demonstrated by Miller _et al_ (2009; 2014), genetic studies indicate that abalone populations (at least of blacklip and greenlip abalone) are made up of what might be termed micro-stocks. In effect, the management units used to set total allowable catches (TACs) and minimum legal sizes (MLS) are indeed just spatial management units (SMUs). The solution adopted in Haddon _et al_ (2013) and Haddon and Mundy (2016) was to generate an operating model made up of numerous relatively small populations of abalone, each with their own set of biological properties and fishery productivity that reflected properties observed within real fisheries. One disadvantage of this approach was that there was no chance of fitting this model to a real fishery as no real fishery has sufficient data available concerning differences in growth, size-at-maturity, and other matters relating to productivity. This meant that one could only attempt to condition the operating model to have outputs and properties that closely matched a real fishery. Of course, as those properties were defined at a large geographical scale there would be no single or unique way of setting up a large number of individual populations to mimic such emergent or sum-of-the-parts properties. 

One time-consuming option to counter this problem would be to set-up the operating models underlying populations in a number of ways to determine whether each different arrangement leads to the same outcome. While this would be time-consuming it is currently the only way available of characterizing the full uncertainty relating to the spatial dynamics. There is the possibility that the use and collection of the GPS data-logger data will assist with the conditioning of the operating model, but such a process remains to be developed. Now there are seven years of data in Tasmania this now is suitable for exploring these possibilities.

### Applications in Victoria

During the project described in Haddon and Mundy (2016), an opportunity arose to apply the abalone MSE to some particular reefs within Western Victoria to examine how their recovery might proceed under different harvest strategies following the viral destruction brought about by the AVG virus (Haddon & Helidoniotis, 2014). This differed from the applications in Tasmania as being focussed solely on one reef complex, known as _The Crags_. While the operating model was still only conditioned on reality using the biological properties known for the abalone on The Crags, more time could be spent improving the comparison of the length composition and historical performance of the fishery. This could be done by selecting combinations of simulated populations whose combined dynamics more closely followed trends in catches and size-composition through time. However, this process was very time-consuming so the objectives of each study need to be made clear and explicit before embarking on such detailed conditioning.

### Why is the Code so Specialized

To date, one reason that running an MSE remains relatively specialized and esoteric is that the simulation framework needs to be able to simulate a wide range of processes (__`r fig_nums("a1",display="cite")`__), including a) the dynamics of the selected biological stock, b) the dynamics of the fishery imposed on the stock, c) the generation of simulated fishery data from the fishery, d) the stock assessment applied to that data, and e) the control rule used to modify the present management options (generally changing the TAC), which are fed back into the dynamics of the stock in a feedback loop within the modelling framework (Punt _et al_, 2016).

<br>

```{r fig.width=6.9, fig.height=4, echo=FALSE}
canvas(xstart=1,xfinish=95,ystart=58,yfinish=93.5)
# top row
makerect(left=2,xinc=27,top=90,yinc=6)
text(4,88,"Implementation of",cex=1.2,pos=4)
text(2,86,"Management Options",cex=1.2,pos=4)
makerect(left=40,xinc=55,top=93,yinc=10.5)
text(52,91.5,"Operating Model",cex=1.4,pos=4)
makerect(left=43,xinc=15,top=90,yinc=6)
text(42.5,88,"Exploitation",cex=1.2,pos=4)
text(45,86,"Fishery",cex=1.2,pos=4)
makerect(left=68,xinc=25,top=90,yinc=6)
text(69.5,88,"Spatial Structure",cex=1.2,pos=4)
text(68,86,"and other dynamics",cex=1.2,pos=4)
arrows(x0=29,y0=87,x1=43,y1=87,length=0.1,angle=30,lwd=4)
arrows(x0=60,y0=88.5,x1=66,y1=88.5,length=0.1,angle=30,lwd=3)
arrows(x0=66,y0=86,x1=60,y1=86,length=0.1,angle=30,lwd=3)
# middle row
text(23,76,"FeedBack",cex=1.2,pos=4)
text(25,74,"Loop",cex=1.2,pos=4)
makerect(left=43,xinc=15,top=78,yinc=6)
text(43,76,"Simulated",cex=1.2,pos=4)
text(42,74,"Fishery Data",cex=1.2,pos=4)
makerect(left=70,xinc=20,top=78,yinc=6)
text(72,76,"Biological",cex=1.2,pos=4)
text(70,74,"Characteristics",cex=1.2,pos=4)
arrows(x0=50,y0=84,x1=50,y1=78,length=0.1,angle=30,lwd=3)
arrows(x0=80,y0=78,x1=80,y1=84,length=0.1,angle=30,lwd=3)
arrows(x0=38,y0=77,x1=38,y1=73,length=0.1,angle=30,lwd=2)
arrows(x0=21,y0=73,x1=21,y1=77,length=0.1,angle=30,lwd=2)
arrows(x0=27.5,y0=80,x1=32.5,y1=80,length=0.1,angle=30,lwd=2)
arrows(x0=32.5,y0=70,x1=27.5,y1=70,length=0.1,angle=30,lwd=2)
# third row
makerect(left=2,xinc=65,top=68,yinc=10.5)
text(12,59,"Harvest Strategy",cex=1.4,pos=4)
makerect(left=38,xinc=28,top=67,yinc=8.5)
text(40,65,"Stock Assessment:",cex=1.2,pos=4)
text(41,62.5,"Calculation of",cex=1.2,pos=4)
text(38,60,"performance measures",cex=1.2,pos=4)
makerect(left=3,xinc=27,top=64,yinc=3)
text(3,62.5,"Harvest Control Rule",cex=1.2,pos=4)
arrows(x0=50,y0=72,x1=50,y1=67,length=0.1,angle=30,lwd=3)
arrows(x0=38,y0=62.5,x1=30,y1=62.5,length=0.1,angle=30,lwd=3)
arrows(x0=18,y0=64,x1=18,y1=84,length=0.1,angle=30,lwd=3)
t <- seq(0,2*pi,length=50) 
coords <- t(rbind( 29+sin(t)*12, 75+cos(t)*(1-35.5/101)*12)) 
points(coords[,1],coords[,2],cex=1.0,pch=1)

```

`r fig_nums("a1", caption=" A diagrammatic representation of the main components of an MSE simulation framework, such as used with abalone, and how the feedback cycle operates during the simulations. Redrawn from Haddon et al, 2013.")`

<br><br>

Developing and using such a complex software framework entailed specialized expertise. The disadvantage of this is that it constrains the application and limits future developments. This is the primary reason for attempting to translate the MSE code into a a self-documented R package. If more people can more easily take on the application of using the management strategy evaluation framework to explore management options for abalone stocks this should increase the chances of improvements in management.  

## Some Background on the Operating Model Structure

The operating model (OM) requires conditioning on a selected abalone fishery because the OM acts as a proxy for reality in the simulations. The task of the OM is to model the stock dynamics across all the micro-stocks embedded in the framework. Currently, a selected abalone fishery zone can have more than 100 sub-populations, each with their own defined properties reflecting somewhat different growth, maturity, and other details relating to productivity. However, such a simulation would be extremely complex to condition to a specific fishery simply because the data requirements would be enormous. For each run of the MSE, the number of populations (_numpop_ in the R code) need to be specified and how these are conditioned will, obviously, greatly influence the outcomes.

The original abalone MSE (Haddon _et al_, 2013) was designed for use with the Tasmanian blacklip abalone stocks. Spatially this was structured as statistical blocks within quota zones. Zones were introduced from 2000 onward whereas the statistical blocks have been extant since before 1980. Biological data was available from many sites around Tasmania although it tended to be summarized at a block level. Each statistical block could be simulated as containing multiple populations, and each population has its own set of properties with many such properties relating to the productivity. To attempt to capture some of the between block variations in biological properties each block simulated was given its own set of properties, which included, for many of the properties, a definition of a statistical distribution to describe the expected distribution of values for such things as the growth parameters, the parameters relating to maturity-at-size, and details of the stock recruitment relation. Thus, each sub-set of populations (in Tasmania representing a statistical block but elsewhere they might represent any spatial management unit), was sampled from selected distributions that had been conditioned on what is known about the fishery being simulated. 

Unfortunately, in fisheries management in general, and abalone fisheries in particular, the terminology used to describe different details and concepts is not standardized across jurisdictions. Thus, while the term _Zone_ is used widely to describe a geographical area over which a particular quota may be taken, the names given to sub-regions within zones differs between jurisdictions. The statistical _block_ from Tasmania is not equivalent to the _reef-code_ from Victoria, or _spatial management unit_ from South Australia. Similarly, in Tasmania, the phrase the _Legal Minimum Length_ (LML) is used to define the legal size limits, which is equivalent to the _Minimum Legal Length_, and other such abbreviations from other jurisdictions.

```{r fig.width=6.9, fig.height=3, echo=FALSE}
canvas(xstart=3,xfinish=88,ystart=55,yfinish=91)
# top row
makerect(left=2,xinc=87,top=90,yinc=35)
text(3,88,"Region",cex=1.6,pos=4)
makerect(left=4,xinc=25,top=85,yinc=28)
makerect(left=33,xinc=25,top=85,yinc=28)
makerect(left=62,xinc=25,top=85,yinc=28)
text(4,83,"SMU",cex=1.4,pos=4)
text(33,83,"SMU",cex=1.4,pos=4)
text(62,83,"SMU",cex=1.4,pos=4)
makerect(5,11,81,11); makerect(17,11,81,11)
makerect(5,11,69,11); makerect(17,11,69,11)
makerect(34,11,81,11); #makerect(46,11,81,11)
makerect(34,11,69,11); makerect(46,11,69,11)
makerect(63,11,81,11); makerect(75,11,81,11)
makerect(63,11,69,11); #makerect(75,11,69,11)
text(4.25,79,"Population",cex=1.0,pos=4)
text(33.25,79,"Population",cex=1.0,pos=4)
text(62.25,79,"Population",cex=1.0,pos=4)
```

`r fig_nums("a2", caption=" A diagrammatic representation of a simulated region made up of a number of spatial management units (SMUs) each made up of a number of separate populations, each with its own properties. In an operational simulated zone there would likely be more SMUs and more populations in at least some of those SMUs and the populations are likely to be of very different sizes, each population with its own particular properties. Redrawn from Haddon et al, 2013.")`


#####
# Setting Up an MSE

## A Worked Example

Rather than continue with hypothetical arrangements it may be simpler to work through an example MSE run in some detail. A potential work flow might begin with these four steps:

1. Generate a draft data template of the number of areas (termed _SMU_ in the R code) to be simulated using the __aMSE__ function _datafileTemplate_.

2. Edit the .csv file created by _datafileTemplate_ to match the conditioning data available for the fishery being simulation tested.

3. Read the data in the edited .csv file into an R object using _readdataFile_, perhaps use the name _condDat_ for conditioning data.

4. Input the _condDat_ into the __aMSE__ function _makeZone_ to generate each of the simulated populations in each of the blocks to generate the simulated zone. This creates the zone, estimates the productivity of each population, and also returns the generated population definitions produced by _makeZone_ to define each population's properties.

5. Plot out the properties of the simulated zone before using it in any testing to ensure that its properties are similar to available data from the fishery it is intended to approximate. 

In this example, we can simplify this procedure by using a built-in data-set called _condDat_. This will avoid having to save a .csv file somewhere and going through the editing stage, which we will describe in more detail when conditioning the operating model is discussed and described.

```{r "getData", results="hold"}
starttime <- as.character(Sys.time())
library(rutilsMH)
library(aMSE)
setpalette("R4")
 rundir <- tempdir()
 outdir <- setupdirs(rundir)
 datadir <- outdir$datadir
 plotdir <- outdir$plotdir
 runname <- "run1" 
# ctrl <- readctrlfile(datadir,infile="control.csv")
# runname <- ctrl$runlabel
# region1 <- readregionfile(datadir,ctrl$regionfile)
# glb <- region1$globals
# constants <- readdatafile(datadir,ctrl$datafile,glb)
# ans <- makeregionC(region1,constants)
# regionC <- ans$regionC
# popdefs <- ans$popdefs
# ans <- makeregion(glb,regionC)
# regionC <- ans$regionC  # region constants
# regionD <- ans$regionD  # region dynamics
#  str(regionC[[1]])
# ans <- findunfished(regionC,regionD,glb)
# regionC <- ans$regionC  # region constants
# regionD <- ans$regionD  # region dynamics
# product <- ans$product
# These datasets are instead of generating the objects as above
 data("testregC")
 data("testregD")
 data("constants")
 data(product)
 data("region1")
 glb <- region1$globals
 
```

Which determines that there will be two blocks, one with two populations, and the other with four. There are no fishery data (catches or cpue) but we will project the model 20 years into the future. The approach adopted for mimicking an abalone fishery region. 

The _constants_ object contains the probability density distribution definitions that are sampled to provide the particular biological properties for each population. Each separate block (SMU) has its own set of parameters so that spatial differences can be incorporated in the conditioning.

The object generated by _makeZone_ contains three objects, the first is a complex object containing complete descriptions of each population, the second is a three dimensional array containing the estimated productivity dynamics for each population, and the final object, _popdefs_, is a simple matrix containing the specific biological properties generated for each population. 

```{r "firstZone"}
regionC <- testregC
str(regionC[[1]])
regionD <- testregD
str(regionD)
```

\newline

Descriptions of each of the parameters and the details of the strategy used to generate the OM zone are described in the appendix. Here we will proceed by generating a description of the properties of this example zone. 

Firstly, the populations within the simulated zone making up the Operating Model (OM) all have somewhat different properties. These particular values derive from the array of probability density functions (PDFs) defined in the _constnats_ within _condDat_. These parameters can be seen in detail by using the function _writeConstants_ which takes as input the _condDat_ object. Each population is given different properties through random samples being taken from the PDFs. The variation between populations is most noticeable in the growth parameters, the size-at-maturity, and the average recruitment.

`r tab_nums("a1", caption=" The constants used to define the six populations that make up the example zone implied by the built in data set condDat. The variable Mc is now redundant, Some parameters appear to be zero because of rounding.")`

```{r echo=FALSE }


```

\newline

The _popdefs_ tabulate the differences but they can be visualized by plotting the implied growth curves, the implied maturity-at-length, the implied weight-at-length.












# References

Haddon, M. (2007) Fisheries and their management. Pp 515-532. In _Marine Ecology_ (_eds_) S.D. Connell & B.M. Gillanders. Oxford University Press. 630 p.

Haddon, M. (2011) _Modelling and Quantitative Methods in Fisheries_. 2nd Ed. CRC/Chapman & Hall. 449p.


Haddon, M. and F. Helidoniotis (2013) Legal minimum lengths and the management of abalone fisheries. _Journal of Shellfish Research_ __32__:197-208

Haddon, M. and F. Helidoniotis (2014) _Modelling the Potential for Recovery of Western
Victorian Abalone Stocks: The Crags_. Interim Report to 2012/225. Hobart. 61 p.

Haddon, M., Mayfield, S., Helidoniotis, F., Chick, R. and C. Mundy (2013) _Identification and Evaluation of Performance Indicators for Abalone Fisheries_. FRDC Final Report 2007/020. CSIRO Oceans and Atmosphere and Fisheries Research Development Corporation. 295 p.

Haddon, M. and C. Mundy (2016) _Testing abalone empirical harvest strategies for setting TACs and associated LMLs, which include the use of novel spatially explicit performance measures._ FRDC Final Report 2011/028. CSIRO Oceans and Atmosphere and Fisheries Research Development Corporation. Hobart 182p.

Haddon, M., Mundy, C., and D. Tarbath (2008) Using an inverse-logistic model to describe growth increments of blacklip abalone (_Haliotis rubra_) in Tasmania. _Fishery Bulletin_ __106__:58-71

Helidoniotis, F., Haddon, M., Tuck, G., and D. Tarbath (2011) The relative suitability of the von Bertalanffy, Gompertz and inverse logistic models for describing growth in blacklip abalone populations (_Haliotis rubra_) in Tasmania, Australia. _Fisheries Research_ __112__: 13-21

Miller, K.J., Maynard, B.T. and C.N. Mundy (2009) Genetic diversity and gene flow in collapsed and healthy abalone fisheries _Molecular Ecology_ __18__: 200-211

Miller, K.J., Mundy, C.N., and S. Mayfield (2014) Molecular genetics to inform spatial management in benthic invertebrate fisheries: a case study using the Australian Greenlip Abalone _Molecular Ecology_ __23__: 4958-4975

Punt, A.E., Butterworth, D.S., de Moor, C.L., De Oliveira, J.A.A. and M. Haddon (2016) Management strategy evaluation: best practices. _Fish and Fisheries_ __17__: 303-334 DOI: 10.1111/faf.12104

Smith, A.D.M. (1997) Quantification of objectives, strategies and performance criteria for fishery management plans—an Australian perspective.  p291–295 _in_ Hancock, D.A., Smith, D.C., Grant, A. and J.P. Beumer (_eds_) _Developing and Sustaining World Fisheries Resources. The State of Science and Management._ Proceedings of the 2nd World Fisheries Congress. CSIRO Publishing, Collingwood.



# Appendix 1: Formal Dynamics

### Model Dynamics

The model dynamics follows the numbers-at-size through time as they are affected by natural mortality, somatic growth, fishing mortality, and recruitment. The model developed in Haddon _et al_. (2013) and Haddon and Helidoniotis (2013) used separate vectors of numbers-at-size to describe the cryptic and emergent components of each population. Here the model is simplified through the cryptic and emergent components of the population being contained in the single vector $N_t$, where $N_t$ is assumed to be the numbers-at-size (length) at the start of each year $t$. This simplifies the equations and speeds the calculations although with this approach the effect of emergence needs to be included explicitly in some of the equations describing the dynamics. 

The model structure adopted has half of the survivorship from natural mortality occurring followed by individual growth, then survivorship from fishing mortality, followed by the remaining survivorship from natural mortality. Finally any recruitment in that year is added to the first few size classes of population vector.  If natural mortality is implemented as half natural mortality, that is $\textbf{S}_{h} = e^{-M/2}$, twice a year, with other dynamics between the natural mortality events then the dynamics for the numbers-at-size can be represented in matrix notation as:

$${\bf{N}_{t+1}}={\bf{S}_{h}{AGS}_{h}{N}_{t}+ {R}}$$

## Model Initiation

Consequently, at equilibrium in the absence of fishing mortality (i.e. survivorship from the annual harvest rate, $\textbf{A}$, = 1.0):

$${\bf{N}^{*}={S}_{h}{AGS}_{h}{N}^{*}+ {R}}$$

$${\bf{N}^{*}-{S}_{h}{AGS}_{h}{N}^{*} = {N}^{*}({I-}{S}_{h}{GS}_{h})= {R}}$$

which, finally, implies:


$${\bf{N}^{*}=\left ({I}-{S}_{h}{GS}_{h} \right )^{-1} {R}}$$

If there is an initial estimated fishing mortality rate, this can be defined as the complement of an annual harvest rate and is distributed down the diagonal of an otherwise zero square matrix __A__:


$$A_L = \left (1 - s_{L,t}H_t \right )$$

where $A_L$ is the survivorship of length-class $L$, $s_{L,t}$ is the selectivity of length-class $L$ in year $t$ (which will relate to the Legal Minimum Length = _LML_), and $H_t$ is the fully selected harvest rate in year $t$. With an initial fishing mortality rate the equilibrium numbers for the emergent population would become:


$${\bf{N}^{*}=\left ({I}-{S}_{h}{AGS}_{h} \right )^{-1} {R}}$$


## Biology and Stock Related Statistics

### Emergence

A logistic curve (Haddon, 2011) can be used to describe the transition from the cryptic to the emergent component of the population, but this only becomes influential if natural mortality differs between the two components or if the emergence logistic overlaps with the selectivity curve, and or the Legal Minimum Length (LML).


$$E_L=\frac{1}{1+e^{-\text{Ln}(19)(L-L_E50)/(L_E95-L_E50)}}=\frac{1}{1+e^{-\text{Ln}(19)(L-L_E50)/\delta}}$$


where $E_L$ is the proportion of size-class $L$ that are emergent, and $L_E50$ and $L_E95$ are the usual logistic parameters defining the lengths at which 50% and 95% are emergent. The term $\delta$ is the constant $(L_E95-L_E50)$. Emergence from crypsis only becomes an issue for the dynamics of the model if they are considered to have different natural mortality rates and/or when the emergence curve overlaps with the selectivity curve (which it can do when the LML is low, e.g. 127mm early on in Tasmania, especially on the west coast). Where the selectivity and emergence curves overlap then the proportion remaining in crypsis would act as a refuge, effectively reducing the fishing mortality on those size classes.

### Growth

The growth from size-class $j$ to size-class $i$ is described by the elements of a growth transition matrix defined by:


$$\begin{align}
  & \begin{matrix}
   {{G}_{i,j}}=\int\limits_{-\infty }^{{{L}_{i}}+\frac{LW}{2}}{\frac{1}{\sqrt{2\pi }{{\sigma }_{j}}}\exp \left( -\left[ \frac{{{L}_{i}}-{{{\bar{L}}}_{j}}}{2{{({{\sigma }_{j}})}^{2}}} \right] \right)}dL & {{L}_{i}}={{L}_{Min}}  \\
\end{matrix} \\ 
 & \begin{matrix}
   {{G}_{i,j}}=\int\limits_{{{L}_{i}}-\frac{LW}{2}}^{{{L}_{i}}+\frac{LW}{2}}{\frac{1}{\sqrt{2\pi }{{\sigma }_{j}}}\exp \left( -\left[ \frac{{{L}_{i}}-{{{\bar{L}}}_{j}}}{2{{({{\sigma }_{j}})}^{2}}} \right] \right)}dL & {{L}_{Min}}<{{L}_{i}}\le {{L}_{Max}}  \\
\end{matrix} \\ 
\end{align}$$

where $G_{i,j}$ is the probability of growing from size class $j$ into size class $i$, $LW$ is the size-class width, $$j is the standard deviation of the normal curve describing the growth increments of animals starting in size class $j$, $L_i$ is the length of size class $i$, and $\bar{L}_{j}$ is the mean growth increment of animals starting from the mean of size-class $j$. $L_{Min}$ and $L_{Max}$ are the minimum and maximum size-classes, with the maximum being treated as a plus group. To ensure that all columns sum to 1.0 (to prevent growth implying losses of its own), and to make $L_{Max}$ a plus group, the final row of the matrix is modified for each column $j$ as:


$${{G}_{{L}_{Max,j}}}={{G}_{{L}_{Max,j}}}+\left( 1-\sum\limits_{i={{L}_{1}}}^{{{L}_{Max}}}{{{G}_{i,j}}} \right)$$

The expected mean growth increment for each size-class $i$ is defined using an inverse logistic growth curve that has been found to describe blacklip abalone growth well (Haddon et al. 2008; Helidoniotis et al., 2011):

$${\bar{L}}_{i,j}={{L}_{j}}+\frac{Max\Delta L}{1+{{e}^{\text{Ln}\left( 19 \right)\left( {{L}_{j}}-{{L}_{g}}50 \right)/\left( {{L}_{g}}95-{{L}_{g}}50 \right)}}}+{{\varepsilon }_{{{L}_{j}}}}$$

$Max \Delta L$ is the maximum growth increment for the population, $L_m50$ and $L_m95$ are the usual logistic parameters defining the lengths at which 50% and 5% of the maximum growth increment are expressed. The ${\varepsilon}_{{L}_{i}}$ is the 
Variation around the mean expected growth increment. It is assumed to be normally distributed with a standard deviation that varies with the growth increment (Haddon et al. 2008):


$${{\sigma }_{{{L}_{j}}}}=\frac{Max{{\sigma }_{L}}}{1+{{e}^{\text{Ln}\left( 19 \right)\left( {{L}_{j}}-{{L}_{g}}95 \right)/\left( L_{Max}-{{L}_{g}}95 \right)}}}$$

The $\left( L_{Max}-{{L}_{g}}95 \right)$ remains a constant and can be parameterized as such ($\delta_g$).

### Weight-at-Length

The weight-at-length, $W_L$, relationship involves two constants:


$$W_L=aL^b$$

### Maturity-at-Length


Maturity at size, $m_L$,  uses an alternative logistic curve, again with two parameters, only this time $L_{50}\% = -{\alpha}/{\beta}$ and the inter-quartile distance is $2{\text{Ln}}3 \beta$.


$$m_L=\frac{exp(\alpha + \beta L)}{1+exp(\alpha + \beta L)}=\frac{1}{1+\left(exp(\alpha + \beta L)  \right)^{-1}}$$

### Selectivity

Selectivity, $S_{L,t}$ for length $L$ in year $t$ needs to be defined by year to permit changes in the LML to be reflected in the selectivity by divers. This implies that rather than a single vector of values, a matrix of selectivity values will be required, one column per year. Each year's selectivity is defined as:



$$S_{L,t}=\frac{1}{1+{exp \left [ {-\text{Ln}(19)( L-{L_{s}}50)/{\delta}} \right ] }}$$

where $\delta=L_s95-L_s50$. 

### Spawning and Exploitable Biomass 

Mature or spawning biomass needs to include numbers-at-size by maturity-at-size and weight-at-size:


$$B_{t}^{S}=\sum\limits_{L={{L}_{Min}}}^{{{L}_{Max}}}{\left( {m_L}{W_L}{N_{L,t}} \right)}$$


Spawning biomass is, like exploitable biomass, calculated in the same units as the $W_L$ equation. If that is in grams then it requires division by 1e6 to estimate tonnes, if in kg then division by 1000 is required. Exploitable biomass, here, is estimated after half of natural mortality and growth have occurred and before any fishing mortality occurs in any single year. Only emergent biomass is considered as no fishing mortality is imposed on the cryptic component, but this is only important is the emergence curve overlaps the selectivity curve:


$$B_{t}^{E}=\sum\limits_{L={{L}_{Min}}}^{{{L}_{Max}}}{{{s}_{L,t}}{{E}_{L}}{{W}_{L}}G_{L,j}{e^{-M/2}}N_{L,t}}$$

where the exploitable numbers-at-size $L$ in year $t$, ${{N}_{L,t}^{E}}$, is obtained from


$${{N}_{L,t}^{E}}=G_{L,j}{e^{-M/2}}{{s}_{L,t}}{{E}_{L}}N_{L,t}$$

where $N_{L,t}$ is the numbers-at-size $L$ at the start of year $t$.

### Catchability

Catchability in a stock assessment model can be estimated analytically as:


$$q=\exp \left[ \sum\limits_{t=1}^{n}{Ln\left( {{I}_{t}}/B_{t}^{E} \right)}/n \right]$$

where $n$ is the number of years across which the observed catch rates, $I_t$, and predicted exploitable biomass are considered. In the simulation/operating model a maximum catch rate, $CE_{Max}$ was used to scale the unfished exploitable biomass to generate a catchability value for each population. The maximum catch rates were randomly selected from a pre-specified distribution, and then the following equation used:


$$q_p=\frac{CE_{Max}}{B_{0,p}^{E}}$$

where $p$ is the index for each population and ${B_{0,p}^{E}}$ is the unfished exploitable biomass for population $p$.

### Annual Model Dynamics

Once each population is initiated its dynamics can be projected forwards a year at a time depending on how much catch is expected to be taken or how much effort is expected to be focussed into each population. The population initiation sets up the equilibrium numbers for the properties defined for each population. Then, given a specific harvest rate for each population they can be projected forward in yearly steps. This projection is based around how the numbers-at-size change through fishing, growth, natural mortality, and recruitment. As before, the fishing mortality rate over a year is defined as the complement of an annual harvest rate and is distributed down the diagonal of an otherwise zero matrix __A__:

$$A_L=\left(1-{s_{L,t}H_t} \right)$$

where $A_L$ is the survivorship of length class $L$, $s_{L,t}$ is the selectivity of length class $L$ in year $t$, and $H_t$ is the fully selected harvest rate in year $t$ (the harvest rate being the proportion of exploitable biomass taken as catch). We can define the survivorship from applying half of natural mortality as follows:

$$O_S=e^{-M/2}$$

$O_S$ does not need to be a vector as multiplying a matrix or vector by a constant is simpler. We apply this survivorship twice in a year with the other dynamics occurring between:

$${\bf{N_{t+1}}}={O_S}\left[{\bf{GA_t}}{O_S}{\bf{N_t}}\right] + {\bf{R}}  $$

\newline

### Recruitment Processes

Recruitment is described using a vector with all new recruits allocated to the first size class and all other size classes being set to 0. A Beverton-Holt stock recruitment relationship was assumed, with a and b parameters that were restructured in terms of steepness, h; unfished mature biomass, $B_{0}^{Sp}$ ; and the average unfished recruitment level, $R_0$:

$$a=\frac{4h{{R}_{0}}}{5h-1}\text{     and      }b=\frac{{{B}_{0}}\left( 1-h \right)}{5h-1}$$

Using this reparameterization the Beverton-Holt relationship becomes:

$${{R}_{t+1}}=\begin{matrix}
   \frac{4h{{R}_{0}}B_{t}^{Sp}}{\left( 1-h \right)B_{0}^{Sp}+\left( 5h-1 \right)B_{t}^{Sp}}, & \varepsilon =N\left( 0,\sigma _{R}^{2} \right)  \\
\end{matrix}$$

The expected residual error distribution around the recruitment is log-normal; ${\sigma}_{R}$ is the standard deviation  of the natural logarithm of the recruitment residuals, and $-{\sigma}_{R}^{2}/2$ is a bias correction term that ensures that the time series of estimated recruitments relates to the mean rather than the median recruitment level (Hastings & Peacock 1975). If the ${\sigma}_{R}$ term is set as a very small number, the recruitment will be effectively deterministic.

$A_0$ can be defined as the mature stock biomass that would develop given a constant recruitment level of 1. Thus, at a biomass of $A_0$, distributed across a stable size distribution, the resulting recruitment level would be $R_0=1$. $A_0$ acts as a scaling factor in the recruitment equations by providing the link between $R_0$ and $B_{0}^{Sp}$. $A_0$ can thus be estimated by setting the annual recruitment level to 1, obtaining the equilibrium size distribution using Eqs (23) and (24), and then applying Eq (3.16). At the virgin biomass per recruit, $A_0$, the average unfished recruitment level, $R_0$, is related directly to the unfished mature, or spawning, biomass, $B_{0}^{Sp}$:

$$B_{0}^{Sp}={R_0}{A_0}$$

In the simulations, the relative size of each population is defined by randomly selecting (from a log-normal distribution) an initial unfished average recruitment, R0, which, given the equilibrium size distribution, provides an estimate of the population\'s unfished mature biomass $B_{0}^{Sp}$.

### Larval Dispersal

To be developed.

### Model Initiation

